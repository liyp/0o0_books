# cloud-pushService 推送计算模块说明

[TOC]

## 业务需求
详见：[云平台产品软件发布管理说明文档][1]

* OA 发布推送通知
	* 固件发布
	* 固件召回
	* 插件发布
	* APP 发布
* 终端推送信息到APP
	* deviceMessage
	* IPCamera 设备

### 固件发布
> 通知方式：共有4种方式，通知内容推送到路由器和管理APP。
1. 进入路由器WEB管理界面弹出框提示（显示软件说明）：终端登录到路由器的WEB管理界面，主动弹出对话框显示软件说明。推送途径：由云服务器直接发给路由器。
2. APP消息推送显示（显示通知内容）: 手机消息通知栏显示APP收到的通知内容。有2种推送途径：APP使用云账号登录，通知由云服务器直接发给APP；APP使用管理员密码登录，路由器收到通知之后再发给APP。
3. APP连接到路由器时页面弹框（显示软件说明）: APP连接到某个路由器时，主动弹出对话框显示该通知内容。推送途径：由云服务器直接发给路由器。
4. APP连接到路由器在实时消息模块显示:APP连接到某个路由器时，在状态页面的实时消息模块显示该通知内容。推送途径：由云服务器直接发给路由器。
> 通知的发送目标：
1. 通知设备：指定设备型号+硬件版本+软件版本的设备进行通知，也可以不选择；
2. 通知地区：选定部分地区的设备进行通知；
3. 通知数量：针对一定数量的设备进行通知；  
>
具体的实现为：在同时符合通知设备和通知地区的设备范围内，抽取最近连接到云的指定数量发送通知。
>
例外情况：
1. 同一软件无法进行多少次发布，对同一设备仅推送一次消息；
2. 强制升级，消息推送成功，但设备没有升级成功，则需要重新推送消息。
>
局部发布时，预警机制:  
设定更新量预警后，当云端达到指定更新量的设备连接时，触发预警策略，云端向指定邮箱发送预警邮件。邮件格式与模板见附件。


### 插件发布
> 通知发送的方式：共有4种方式，通知内容推送到路由器和管理APP。
1. 进入路由器WEB管理界面弹出框提示（显示通知内容）：终端登录到路由器的WEB管理界面，主动弹出对话框显示通知内容。推送途径：由云服务器直接发给路由器。
2. APP消息推送显示（显示通知内容）: 手机消息通知栏显示APP收到的通知内容。有2种推送途径：APP使用云账号登录，通知由云服务器直接发给APP；APP使用管理员密码登录，路由器收到通知之后再发给APP。
3. APP连接到路由器时页面弹框（显示通知内容）: APP连接到某个路由器时，主动弹出对话框显示该通知内容。推送途径：由云服务器直接发给路由器。
4. APP连接到路由器在实时消息模块显示:APP连接到某个路由器时，在状态页面的实时消息模块显示该通知内容。推送途径：由云服务器直接发给路由器。
> 通知的发送目标：
1. 通知设备：指定设备型号+硬件版本+软件版本和已/未安装插件名称+插件版本的设备进行通知，也可以不选择；
2. 通知地区：选定部分地区的设备进行通知；
3. 通知数量：针对一定数量的设备进行通知；
具体的实现为：在同时符合通知设备和通知地区的设备范围内，抽取最近连接到云的指定数量发送通知。
> 例外情况：
1. 同一插件+版本无论进行多少次发布，对同一设备仅推送一次消息；
2. 当研发处对应用插件与软件对应关系表进行更新时，云平台可以实现对应更新。
> 通知推送示例：  
插件A 已有版本1.0、1.1、1.2 ，更新1.3  
对于路由器而言存在以下：已安装1.0、已安装1.1、已安装1.2、未安装A；  
推送通知可能存在情况：
> 局部发布时：  
1. 只通知已安装某一个版本插件如：只通知已安装1.0;
2. 只通知未安装A的用户：未安装A；
3. 通知未安装A和已安装1.0的用户；
>
全局发布：  
通知插件适用的所有的用户：包括：已安装1.0、已安装1.1、已安装1.2、未安装A

### APP 发布
> 通知发送的方式：共有2种方式，通知内容推送到管理APP。
1. APP消息推送显示（显示通知内容）: 手机消息通知栏显示APP收到的通知内容。推送途径：APP使用云账号登录，通知由云服务器直接发给APP；
2. APP启动时页面弹框提示（显示更新说明）：推送途径：通知由云服务器直接发给APP；
通知的发送目标：
3. 通知设备：同一个APP的所有历史版本（默认）；
具体的实现为：在同时符合通知设备和通知地区的设备范围内，抽取最近连接到云的指定数量发送通知。
> 例外情况：
1. 同一APP+版本无论进行多少次发布，对同一设备仅推送一次消息；
2. 当研发处对APP发布单进行更新时，云平台可以实现对应更新。


[1]:  \\file.tp-link.net\云项目资料 "云平台产品软件发布管理说明文档"

## APP行为

### 账号登陆限制

* 账号单用户登陆限制
    - 
* 账号多用户共享登陆限制
